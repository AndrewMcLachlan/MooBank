# Frontend Refactoring Plan: 3 Phases

## Context

MooBank's frontend has 22+ hand-coded service hook files, centralized in `src/services/`, using custom `useApi*` hooks from `@andrewmclachlan/moo-app`. Hey-api is already configured and generating code to `src/api/` but isn't consumed yet. Routing uses React Router v7 with a centralized `Routes.tsx` config. This plan modernizes the data layer, routing, and file organization in three phases, each building on the last.

### Decisions Made
- **moo-app**: Will be updated to support TanStack Router (user controls this package)
- **Route structure**: True file-based routing — page components move into `src/routes/`, not thin wrappers
- **Types**: Migrate from hand-written `src/models/` to generated `src/api/types.gen.ts`

---

## Phase 1: Replace Services with Hey-API Generated Hooks

**Goal**: Replace all 22 hand-coded service files with hey-api generated hooks. Migrate from hand-written model types to generated types.

### Current State
- `src/services/` — 22 files exporting ~90 hooks using `useApiGet`, `useApiPost`, etc. from moo-app
- `src/api/` — Already generated by hey-api: `sdk.gen.ts`, `types.gen.ts`, `@tanstack/react-query.gen.ts`
- `src/models/` — 41 hand-written model/DTO files with domain helpers (`emptyAccount`, `isCredit`, `sortTags`)
- Generated hooks export `*Options()` factories (for `useQuery`) and `*Mutation()` factories (for `useMutation`), not `use*` hooks directly

### Key Patterns to Preserve
- **Toast notifications**: 11 service files, 24 `toast.promise` call sites
- **Optimistic updates**: 7 service files, 14 `onMutate` handlers (TransactionService, RuleService, TagService, VirtualInstrumentService, InstitutionService, FamilyService, RecurringTransactionService)
- **Cache invalidation**: Nearly all mutation hooks
- **Redux dependency**: TransactionService and StockTransactionService read filter/pagination state from Redux to construct query keys

### Step 1.1: Verify hey-api generation and type mapping
- Run `npm run generate` and confirm output is current
- Audit `src/api/types.gen.ts` vs `src/models/` — map each hand-written type to its generated equivalent
- Identify domain helper functions in models that have no generated equivalent and need to be preserved as utilities
- **Files**: `openapi-ts.config.ts`, `src/api/types.gen.ts`, `src/models/**`

### Step 1.2: Migrate model types
- Components currently import from `src/models/`. Switch these imports to `src/api/types.gen.ts`
- Move helper functions (`emptyAccount`, `isCredit`, `sortTags`, `getSplitTotal`, `emptyTransaction`, `emptyTransactionSplit`, `AccountTypes`, etc.) to utility files in `src/helpers/`
- Update all ~76 component files importing from `src/models/`
- Delete `src/models/` once fully migrated
- **Files**: All files importing from `"models"` or `"models/*"`

### Step 1.3: Migrate simple query-only services (batch 1)
Services with NO mutations, no optimistic updates, no toast — pure reads:
- `ReferenceDataService.ts` (1 hook)
- `InstrumentsService.ts` (2 hooks)
- `ReportsService.ts` (9 hooks)

Pattern change:
```typescript
// Before
export const useTags = () => useApiGet<Tag[]>(["tags"], "api/tags");
// After
export const useTags = () => useQuery(getTagsOptions());
```

### Step 1.4: Migrate query + cache-invalidation services (batch 2)
Services with mutations that only do cache invalidation (no toast, no optimistic updates):
- `BudgetService.ts`
- `GroupService.ts`

**Important**: Migrate entire service files at once (queries AND mutations together) to avoid query key mismatches. Generated query keys use structured objects, not simple string arrays.

### Step 1.5: Migrate toast-wrapping services (batch 3)
Services with `toast.promise` wrappers but no optimistic updates:
- `AccountService.ts`, `AssetService.ts`, `StockHoldingService.ts`, `BillService.ts`
- `VirtualInstrumentService.ts` (partial — create/close only)
- `UserService.ts`, `StockTransactionService.ts`, `ForecastService.ts`, `ImportService.ts`

Pattern change for mutations:
```typescript
// Before (moo-app tuple pattern)
const { mutateAsync } = useApiPost<Result, Vars, Body>((v) => `api/accounts`, { onSettled: ... });
return { mutateAsync: (body) => toast.promise(mutateAsync([null, body]), {...}) };

// After (hey-api options pattern)
const { mutateAsync } = useMutation({ ...createAccountMutation(), onSettled: ... });
return { mutateAsync: (body) => toast.promise(mutateAsync({ body }), {...}) };
```

### Step 1.6: Migrate optimistic-update services (batch 4 — hardest)
- `TransactionService.ts` (3 optimistic mutations + Redux state dependency)
- `RuleService.ts` (4 optimistic mutations)
- `TagService.ts` (3 hooks using raw `useMutation` + `useHttpClient()`)
- `VirtualInstrumentService.ts` (balance update — complex multi-key optimistic update)
- `InstitutionService.ts`, `FamilyService.ts`, `RecurringTransactionService.ts`

Key challenge: Optimistic updates reference specific query keys — these must use the NEW generated key format. TransactionService also reads Redux state to construct exact cache keys.

### Step 1.7: Handle special cases
- `useApiPagedGet` in TransactionService, StockTransactionService, BillService — verify generated hooks handle pagination params
- `useApiPostFile` in ImportService — verify generated code handles `multipart/form-data` file uploads

### Step 1.8: Clean up
- Remove all `useApi*` and `useHttpClient` imports from `@andrewmclachlan/moo-app` across service files
- Delete `src/services/Mutations.ts` if unused
- Run `npm run build && npm run lint`

### Phase 1 Verification
- `npm run build` passes with zero errors
- `npm run lint` passes
- No service file imports from `@andrewmclachlan/moo-app` API hooks
- All consumer components compile without changes to their hook call sites
- Smoke test: Dashboard, Account list, Transactions (filter/sort/page), Tag CRUD, Budget, Reports, Import, Virtual account balance update
- Optimistic updates still work (tag a transaction → immediate UI update)
- Toast notifications appear for all mutations
- `src/models/` deleted, all components use generated types

### Phase 1 File Impact
- **Modified**: 22 service files (internals rewritten, exports unchanged) + ~76 component files (model imports)
- **Deleted**: `src/models/` (41 files), possibly `src/services/Mutations.ts`
- **Created**: Utility files in `src/helpers/` for migrated domain helpers

---

## Phase 2: Switch to TanStack Router (File-Based Routing)

**Goal**: Replace React Router with TanStack Router. Page components move into `src/routes/` — the file structure IS the routing structure.

### Current State
- React Router v7.13.0 with centralized `Routes.tsx` using `RouteDefinition` from moo-app
- `createMooAppBrowserRouter(routes)` in App.tsx
- 48 files import from `react-router` (`useNavigate`, `useParams`, `useMatch`, `Navigate`, `Outlet`, `Link`)
- `useIdParams()` from moo-app used in many components
- Auth at Layout level via MSAL `useIsAuthenticated()`
- No lazy loading currently

### Step 2.1: Update `@andrewmclachlan/moo-app` for TanStack Router
- Add TanStack Router support to moo-app (new `createMooAppTanStackRouter` or update existing API)
- Ensure `MooApp` component can accept a TanStack Router instance
- Ensure `MooAppLayout` renders TanStack Router's `<Outlet />`
- Add TanStack-compatible `useIdParams()` hook
- **Repo**: https://github.com/AndrewMcLachlan/MooApp

### Step 2.2: Install dependencies and configure Vite plugin
```
Add: @tanstack/react-router, @tanstack/react-router-vite-plugin, @tanstack/react-router-devtools (dev)
Remove (later): react-router, react-router-bootstrap
```
Configure in `vite.config.ts`:
```typescript
import { TanStackRouterVite } from '@tanstack/react-router-vite-plugin';
// Add to plugins: TanStackRouterVite({ routesDirectory: './src/routes', generatedRouteTree: './src/routeTree.gen.ts' })
```
- **Files**: `package.json`, `vite.config.ts`

### Step 2.3: Create route file structure
Move page components from `src/pages/` into `src/routes/`. Non-route files use TanStack's `-` prefix convention.

```
src/routes/
├── __root.tsx                              # Layout (auth, sidebar, header)
├── index.tsx                               # / → Dashboard
├── accounts/
│   ├── index.tsx                           # /accounts
│   ├── create.tsx                          # /accounts/create
│   └── $id/
│       ├── route.tsx                       # Layout: loads account, provides context
│       ├── transactions.tsx                # /accounts/$id/transactions
│       ├── rules.tsx
│       ├── manage/
│       │   ├── index.tsx                   # /accounts/$id/manage
│       │   ├── bank.create.tsx
│       │   └── virtual.create.tsx
│       │   └── virtual.$virtualId.tsx
│       ├── reports/
│       │   ├── route.tsx                   # Reports layout
│       │   ├── in-out.tsx
│       │   ├── breakdown.$tagId.tsx
│       │   ├── by-tag.tsx
│       │   ├── tag-trend.$tagId.tsx
│       │   ├── all-tag-average.tsx
│       │   └── monthly-balances.tsx
│       └── virtual.$virtualId/
│           ├── route.tsx                   # Virtual account layout
│           ├── transactions.tsx
│           └── manage.tsx
├── bills/
│   ├── index.tsx
│   ├── $id.tsx
│   └── accounts/
│       ├── index.tsx
│       ├── create.tsx
│       └── $id.tsx
├── shares/
│   ├── create.tsx
│   └── $id/
│       ├── route.tsx
│       ├── manage.tsx
│       └── transactions/
│           ├── index.tsx
│           └── add.tsx
│       └── reports/
│           ├── route.tsx
│           └── value.tsx
├── assets/
│   ├── create.tsx
│   └── $id/
│       ├── route.tsx
│       └── manage.tsx
├── budget/
│   ├── index.tsx
│   └── report.$year.$month.tsx
├── forecast.tsx
├── settings/
│   ├── route.tsx
│   ├── families/
│   │   ├── index.tsx
│   │   ├── add.tsx
│   │   └── $id.tsx
│   └── institutions/
│       ├── index.tsx
│       ├── add.tsx
│       └── $id.tsx
├── tags/
│   ├── index.tsx
│   └── visualiser.tsx
├── groups/
│   ├── index.tsx
│   ├── create.tsx
│   └── $id/
│       ├── manage.tsx
│       └── reports.monthly-balances.tsx
├── profile.tsx
├── family.tsx
└── $.tsx                                   # Catch-all 404
```

### Step 2.4: Migrate incrementally — start with leaf routes
1. Simple leaf routes first: `profile.tsx`, `family.tsx`, `forecast.tsx`, `$.tsx` (404)
2. Single-level feature routes: `budget/`, `tags/`, `groups/`
3. Nested features: `accounts/`, `bills/`, `shares/`, `assets/`, `settings/`

For each route, the file exports a `Route` using `createFileRoute` or `createLazyFileRoute`:
```typescript
import { createFileRoute } from '@tanstack/react-router';

export const Route = createFileRoute('/profile')({
    component: ProfilePage,
});

function ProfilePage() { /* moved from src/pages/user/Profile.tsx */ }
```

### Step 2.5: Replace React Router imports (48 files)
| React Router | TanStack Router |
|---|---|
| `useNavigate()` | `useNavigate()` from `@tanstack/react-router` |
| `useParams()` | `Route.useParams()` (type-safe) or `useParams({ strict: false })` |
| `useMatch(path)` | Route-level `beforeLoad` or `useMatch()` |
| `<Navigate to>` | `<Navigate to>` from `@tanstack/react-router` |
| `<Outlet />` | `<Outlet />` from `@tanstack/react-router` |
| `<Link to>` | `<Link to>` from `@tanstack/react-router` |
| `useIdParams()` (moo-app) | `Route.useParams().id` (type-safe) |

### Step 2.6: Update App.tsx
```typescript
import { routeTree } from './routeTree.gen';
import { createRouter } from '@tanstack/react-router';
const router = createRouter({ routeTree });
// Pass to updated MooApp component
```
- **Files**: `src/App.tsx`

### Step 2.7: Enable lazy loading
Use `createLazyFileRoute` for non-critical routes to enable code splitting (not available with current React Router setup).

### Step 2.8: Clean up
- Delete `src/Routes.tsx`
- Delete `src/pages/` (all content moved to `src/routes/`)
- Remove `react-router`, `react-router-bootstrap` from `package.json`
- Remove `src/hooks/useAccountRoute.ts`, `src/hooks/useAccountParams.ts` (replaced by type-safe route params)
- Run `npm run build && npm run lint`

### Phase 2 Verification
- `npm run build` passes
- `npm run lint` passes
- No imports from `react-router` remain
- All routes render correctly, navigation works (sidebar, header, programmatic)
- URL params work for all routes
- Redirects work (`/accounts/:id` → `/accounts/:id/transactions`)
- 404 page works
- Browser back/forward works
- Lazy loading active for at least some routes

### Phase 2 File Impact
- **Created**: ~55 route files in `src/routes/`, `src/routeTree.gen.ts` (auto-generated)
- **Modified**: `vite.config.ts`, `package.json`, `src/App.tsx`, ~48 files with react-router imports, moo-app package
- **Deleted**: `src/Routes.tsx`, `src/pages/` (moved to routes), routing-specific hooks

---

## Phase 3: Co-locate Hooks with Components

**Goal**: Move custom hooks (service wrappers with toast/optimistic updates/invalidation) to live alongside their consuming components in `src/routes/`. Generated hooks stay in `src/api/`. One hook per file, organized in `-hooks/` directories.

### Current State (after Phases 1 & 2)
- `src/services/` — 22 wrapper hook files (using generated hey-api hooks internally)
- `src/routes/` — All page components organized by route
- `src/api/` — Generated hooks (untouched)
- `src/hooks/` — 7 custom hooks

### Step 3.1: Classify hooks by usage scope

**Single-feature hooks** (move to feature's `-hooks/` directory, one file per hook):
- Budget hooks → `src/routes/budget/-hooks/useBudgetReport.ts`, `useCreateBudgetLine.ts`, etc.
- Forecast hooks → `src/routes/forecast/-hooks/useForecastPlans.ts`, `useRunForecast.ts`, etc.
- Rule hooks → `src/routes/accounts/$id/-hooks/useRules.ts`, `useCreateRule.ts`, etc.
- Stock transaction hooks → `src/routes/shares/$id/transactions/-hooks/useStockTransactions.ts`, etc.
- Recurring transaction hooks → `src/routes/accounts/$id/virtual.$virtualId/-hooks/useRecurringTransactions.ts`, etc.
- Bill hooks → `src/routes/bills/-hooks/useBills.ts`, `useCreateBill.ts`, etc.
- Family hooks → `src/routes/settings/families/-hooks/useFamilies.ts`, etc.
- Institution hooks → `src/routes/settings/institutions/-hooks/useInstitutions.ts`, etc.
- User hooks → `src/routes/profile/-hooks/useUser.ts`, `useUpdateUser.ts`, etc.
- Asset hooks → `src/routes/assets/-hooks/useAsset.ts`, `useCreateAsset.ts`, etc.
- Stock holding hooks → `src/routes/shares/-hooks/useStockHolding.ts`, etc.
- Import hooks → `src/routes/accounts/$id/-hooks/useImport.ts`

**Multi-feature hooks** (keep in shared location `src/hooks/`, one file per hook):
- `useTags.ts`, `useCreateTag.ts`, `useUpdateTag.ts`, `useDeleteTag.ts` → used by Tags page, TransactionTagPanel, TagSelector, reports
- `useAccounts.ts`, `useAccount.ts`, `useFormattedAccounts.ts` → used by Accounts, Dashboard, AccountProvider
- Report hooks (`useInOutReport.ts`, `useBreakdownReport.ts`, etc.) → used by Reports pages AND Dashboard widgets
- `useGroups.ts`, `useGroup.ts` → used by Groups pages AND GroupSelector
- `useImporterTypes.ts` → used by CreateInstitutionAccount, InstitutionAccountEdit

### Step 3.2: Move single-feature hooks
For each feature, create a `-hooks/` directory (TanStack Router `-` prefix = excluded from route generation):
1. Split hooks from `src/services/XxxService.ts` into individual files in the feature's `-hooks/` directory
2. One hook per file, named after the hook (e.g., `useCreateBudgetLine.ts`)
3. Update imports in the consuming route components (now co-located, so relative imports)
4. Remove the emptied service file

### Step 3.3: Consolidate shared hooks
Move multi-feature hooks to `src/hooks/`, one file per hook:
- `useAccounts.ts`, `useAccount.ts`, `useFormattedAccounts.ts`, `useCreateAccount.ts`, etc.
- `useTags.ts`, `useCreateTag.ts`, `useUpdateTag.ts`, `useDeleteTag.ts`
- `useInOutReport.ts`, `useBreakdownReport.ts`, `useTopTagsReport.ts`, etc.
- `useGroups.ts`, `useGroup.ts`, `useCreateGroup.ts`, etc.
- `useImporterTypes.ts`

### Step 3.4: Move non-API custom hooks
- `useBudgetYear.ts` → `src/routes/budget/-hooks/useBudgetYear.ts` (single feature)
- `period.ts` → keep in `src/hooks/` (used by multiple report components)
- `useHasRole.ts` → keep in `src/hooks/` (used by Layout)
- `useStateEffect.ts` → keep in `src/hooks/` if shared

### Step 3.5: Delete src/services/
- Remove `src/services/` directory entirely
- Remove `src/services/index.ts` barrel
- Update all remaining imports (70+ files)
- Run `npm run build && npm run lint`

### Phase 3 Verification
- `npm run build` passes
- `npm run lint` passes
- `src/services/` directory deleted
- No circular imports between route directories
- Each feature directory is self-contained (imports from `src/hooks/` for shared, `./-hooks/` for local)
- Shared hooks in `src/hooks/` are genuinely shared (used by 2+ features)
- Every hook file contains exactly one hook

### Phase 3 File Impact
- **Created**: ~60 hook files in `-hooks/` directories across routes, ~20 files in `src/hooks/`
- **Modified**: ~90 files (import path changes)
- **Deleted**: `src/services/` (22 files + index)

---

## Cross-Phase Notes

### Build Verification (after every batch)
```bash
npm run build    # Includes tsc type checking
npm run lint
```

### Git Strategy
- Each batch/step = one commit
- Each phase = separate feature branch with PR

### Risk Assessment
- **Phase 1**: Lowest risk — internal refactoring, no component API changes beyond model imports
- **Phase 2**: Highest risk — structural routing change, requires moo-app updates, affects navigation
- **Phase 3**: Low risk, high file count — mechanical import path changes

### Critical Files
- `src/services/TransactionService.ts` — Most complex service (optimistic updates + Redux + toast + pagination)
- `src/api/@tanstack/react-query.gen.ts` — Generated query/mutation factories
- `src/Routes.tsx` — Current route config to decompose
- `src/App.tsx` — Router wiring
- `openapi-ts.config.ts` — Hey-api generation config
